
Описание (спецификация) формата файлов PLT8.
============================================

Введение и общие сведения.
--------------------------

Файлы PLT создаются графическими редакторами комплекса PCAD (PCCAPS и PCCARDS) в качестве упрощенного представления
создаваемого в них изображения, очищенного от любых побочных и сопутствующих сведений, которые в изобилии содержатся
в файлах основных рабочих форматов этих программ (*.SYM, *.SCH, *.PRT, *.PCB). Хранимое в файлах изображение является
векторным и состоит из набора некоторых базовых геометрических примитивов.

Для хранения любых значений в файлах этого формата используются двухбайтовые целые беззнаковые и четырёхбайтовые
целые знаковые величины, хранящиеся в файле с последовательностью байтов Motorola (big-endian, "от старшего к младшему"),
при котором старший байт занимает младший (первый) байт поля в файле.

Все геометрические величины (координаты и толщины) хранятся в виде особых единиц базы данных - DBU.
Связь условных единиц DBU с геометрическими единицами длины зависит от типа создавшего рисунок редактора.

Для редактора PC-CAPS при работе в метрической системе единица координат редактора (единица
при работе в редакторе) соответствует миллиметру, равному 1000 DBU (1 DBU = 0.001 мм).
В английской системе единица координат - сотая доля дюйма = 0.01 дюйма = 10 милов = 0.254 мм
= 100 DBU (1 DBU = 0.0001 дюйма = 0.00254 мм).

Для редактора PC-CARDS единицы DBU на порядок (в 10 раз) плотнее (меньше). Тут при работе
в метрической системе единицей координат редактора по-прежнему является миллиметр, но он уже
соответствует 10000 DBU (1 DBU = 0.0001 мм). В английской системе единицей координат редактора
будет уже тысячная доля дюйма (мил), и в базе данных она будет соответствовать 100 DBU (как и
ранее в PC-CAPS, но там такое соответствие было для сотой дюйма = 10 милов = 100 DBU).
Таким образом, для английской системы в PC-CARDS имеем: 1 DBU = 0.01 мил = 0.00001 дюйма =
0.000254 мм.

Система координат в плоскости изображения декартова, с традиционным направлением координатных осей: ось абсцисс
горизонтальна, направлена слева направо, ось ординат вертикальна, направлена снизу вверх.

Детальное описание структуры и формата файла PLT8.
--------------------------------------------------

Общая структура файла PLT8, создаваемого редакторами комплекса PCAD8, выглядит так:

1. Заголовок фиксированного формата
2. Таблица включённых слоёв
3. Список графических примитивов

Далее каждый из них будет описан подробно.

#### Заголовок фиксированного формата.

Описанный (объемлющий) прямоугольник - прямоугольник, внутри которого помещается всё изображение файла.

|Смещение    | Размер     |    Тип   |          Назначение               |                 Значение                  |
|:----------:|:----------:|:--------:|:---------------------------------:|:-----------------------------------------:|
| 0          | 8 байт     | uint64_t |     Сигнатура формата файла       |          =0x800003BE00000006              |
| 8          | 4 байта    | int32_t  | Координата X левого нижнего угла  |                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 12         | 4 байта    | int32_t  | Координата y левого нижнего угла  |                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 16         | 4 байта    | int32_t  | Координата x правого верхнего угла|                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 20         | 4 байта    | int32_t  | Координата y правого верхнего угла|                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 24         | 4 байта    | uint32_t |      Тип координатной системы     | =0x8 для английской (дюймовой) системы    |
|            |            |          |                                   | =0x9 для метрической системы              |
| 28         | 4 байта    | uint32_t |   Тип редактора-создателя файла   | =0x1, если файл создан редактором PC-CARDS|
|            |            |          |                                   | =0xA, если файл создан редактором PC-CAPS |
| 32         | 4 байта    | uint32_t | Количество записей в таблице слоёв| =NLAY                                     |
| 36         | 4 байта    | uint32_t |       Нулевое двойное слово       | =0, сигнатура завершения заголовка        |

#### Таблица включённых (отображаемых) слоёв

Сразу вслед за заголовком фиксированного формата находится таблица включённых (отображаемых) слоёв. В этой таблице
содержится ровно столько записей, сколько указано в заголовке в поле "Количество записей в таблице слоёв". Длина одной
записи - 16 байт.

##### Структура таблицы слоёв.

|Смещение    | Размер     |     Тип       |            Назначение                |
|:----------:|:----------:|:-------------:|:------------------------------------:|
|  40        |  16 байт   | layer_struct  |  Описание первого включённого слоя   |
| .......... | .......... | ............. | .................................... |
| .......... | .......... | ............. | .................................... |
| 40+N*16    |  16 байт   | layer_struct  | Описание последнего включённого слоя |

#### Описание layer_struct каждого слоя выглядит так:

|Смещение от начала записи| Размер     |    Тип   |       Назначение                 | 
|:-----------------------:|:----------:|:--------:|:--------------------------------:|
| 0                       | 8 байт     | char[8]  |         Имя слоя                 |
| 8                       | 4 байта    | uint32_t |Порядковый номер слоя в исходной  |
|                         |            |          |таблице слоёв редактора           |
| 12                      | 4 байта    | uint32_t |Индекс палитры - цвет, назначенный|
|                         |            |          |слою (от 0 до 15)                 |

Все строки в файлах формата PLT8 хранятся в очень специфическом виде, связанном с повсеместным 
использованием для записи полей с данными последовательности байт "big-endian". Четырёхбайтовые
сборки символов строк также подвергаются связанной с этим инверсии.

Для наилучшего понимания преобразования, необходимого для правильного считывания строковых данных,
опишем процесс, который совершается редакторами PCAD8 при их сохранении в файл.

Пусть есть строка, содержащая, в данном случае, имя слоя. Поле для его хранения заполняется данными
строки, если имя короче восьми символов, то дополняется справа нулевыми байтами. Затем поле
разбивается на два двойных слова по 4 байта, каждое из которых разворачивается наоборот (в обратном
порядке байтов). Таким образом, например, имя DEVICE превращается в IVED..EC (. - нулевой байт).
При считывании данных из файла следует провести обратное преобразование.

Основная часть файла - перечисление графических элементов изображения.
----------------------------------------------------------------------

После завершения таблицы слоёв следует массив описаний графических примитивов, и образующих, собственно
изображение. Всего определено 9 геометрических примитивов:

1. Назначение цвета следующим примитивам
2. Отрезок (линия)
3. Прямоугольник
4. Заполненный (закрашенный) прямоугольник
5. Окружность
6. Дуга окружности
7. Строка текста
8. Вспышка (засветка, апертура)
9. Многоугольник (полигон)

Описатели примитивов следуют вплотную друг за другом, без каких-либо разделителей. Они могут иметь как
фиксированный формат, так и переменную длину. Подробное разъяснение их устройства следует далее.

### Описание геометрических примитивов изображения.

#### Назначение цвета следующим примитивам

Длина описателя - 8 байт.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t | Сигнатура примитива "назначение цвета"|        =0x80000419         |
| 4                       | 2 байта    | uint16_t | Индекс палитры - цвет, которым будут  |     Значение от 0 до 15    |
|                         |            |          | рисоваться следующие примитивы (кроме |                            |
|                         |            |          | примитива "закрашенный прямоугольник")|                            |
| 6                       | 2 байта    | uint16_t | Нулевое слово                         |  =0                        |

#### Отрезок (линия)

Длина описателя - 24 байта.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t | Сигнатура примитива "линия (отрезок)" |        =0x80000418         |
| 4                       | 2 байта    | uint16_t |        Ширина (толщина) линии         |                            |
| 6                       | 2 байта    | uint16_t |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 8                       | 4 байта    | int32_t  | Координата X начальной точки отрезка  |                            |
| 12                      | 4 байта    | int32_t  | Координата y начальной точки отрезка  |                            |
| 16                      | 4 байта    | int32_t  | Координата x конечной точки отрезка   |                            |
| 20                      | 4 байта    | int32_t  | Координата y конечной точки отрезка   |                            |

#### Прямоугольник

Длина описателя - 24 байта.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t | Сигнатура примитива "прямоугольник"   |        =0x80000417         |
| 4                       | 2 байта    | uint16_t |        Ширина (толщина) линии         |                            |
| 6                       | 2 байта    | uint16_t |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 8                       | 4 байта    | int32_t  |    Координата X нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 12                      | 4 байта    | int32_t  |    Координата y нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 16                      | 4 байта    | int32_t  |    Координата x верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |
| 20                      | 4 байта    | int32_t  |    Координата y верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |

#### Заполненный (закрашенный) прямоугольник

Длина описателя - 24 байта.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t |   Сигнатура примитива "заполненный    |        =0x80000416         |
|                         |            |          |      (закрашенный) прямоугольник"     |                            |
| 4                       | 2 байта    | uint16_t |     Поле неизвестного назначения      |    =6                      |           
| 6                       | 2 байта    | uint16_t | Цвет рисуемой фигуры - индекс палитры |    Значение от 0 до 15     |
| 8                       | 4 байта    | int32_t  |    Координата X нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 12                      | 4 байта    | int32_t  |    Координата y нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 16                      | 4 байта    | int32_t  |    Координата x верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |
| 20                      | 4 байта    | int32_t  |    Координата y верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |

#### Окружность

Длина описателя - 32 байта.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t |    Сигнатура примитива "окружность"   |        =0x80000415         |
| 4                       | 2 байта    | uint16_t |        Ширина (толщина) линии         |                            |
| 6                       | 2 байта    | uint16_t |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 8                       | 4 байта    | int32_t  |    Координата X центра окружности     |                            |
| 12                      | 4 байта    | int32_t  |    Координата y центра окружности     |                            |
| 16                      | 4 байта    | int32_t  |           Радиус окружности           |                            |
| 20                      | 12 байтов  |int32_t[3]|          Нулевой заполнитель          | =0                         |

#### Дуга окружности

Длина описателя - 32 байта.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t | Сигнатура примитива "дуга окружности" |        =0x800003EA         |
| 4                       | 2 байта    | uint16_t |        Ширина (толщина) линии         |                            |
| 6                       | 2 байта    | uint16_t |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 8                       | 4 байта    | int32_t  |    Координата x центра окружности     |                            |
| 12                      | 4 байта    | int32_t  |    Координата y центра окружности     |                            |
| 16                      | 4 байта    | int32_t  |    Координата x начальной точки дуги  |                            |
| 20                      | 4 байта    | int32_t  |    Координата y начальной точки дуги  |                            |
| 24                      | 4 байта    | int32_t  |    Координата x конечной точки дуги   |                            |
| 28                      | 4 байта    | int32_t  |    Координата y конечной точки дуги   |                            |

Обе конечных точки должны принадлежать дуге, но если вторая точка на ней не лежит, то первая (начальная) точка используется
для расчёта радиуса дуги (расстояние от центра до этой точки) и стартового угла, а вторая (конечная) - только для расчёта
её финального угла.

#### Строка текста

Длина описателя - переменная.

|Смещение от начала записи| Размер   |    Тип    |            Назначение                 |          Значение          |
|:-----------------------:|:--------:|:---------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта  | uint32_t  |  Сигнатура примитива "строка текста"  |         =0x80000412        |
| 4                       | 4 байта  | uint32_t  |         Нулевой заполнитель           |  =0                        |
| 8                       | 4 байта  | int32_t   |   Координата x точки привязки текста  |                            |
| 12                      | 4 байта  | int32_t   |   Координата y точки привязки текста  |                            |
| 16                      | 2 байта  | uint16_t  |         Нулевой заполнитель           |  =0                        |
| 18                      | 2 байта  | uint16_t  |    Ориентация и выравнивание текста   | Детально содержимое поля   |
|                         |          |           |                                       | описано ниже.              |
| 20                      | 4 байта  | uint32_t  |             Высота текста             |                            |
| 24                      |8*N байтов|uint64_t[N]|      Содержимое текстовой строки      | Разъяснение ниже           |

Поле по смещению 18 - "Ориентация и выравнивание текста" - составное поле, определяющее тип ориентации и выключки текста
относительно точки его привязки. Его можно представить как набор битовых полей:

    struct TextOrientAlign
    {
      unsigned text_orientation : 4; // Ориентация текста (направление его вывода)
      unsigned text_align : 8;       // Выравнивание (выключка) текста
      unsigned : 4;                  // Дополнение до целого слова
    };

Ориентацию задаёт младшая тетрада (младшие четыре бита поля "Ориентация и выравнивание текста").

* #### Ориентация (направление) текста

|Значение тетрады|Ориентация текста                   |
|:--------------:|:----------------------------------:|
|       0x0      | направление 0 градусов, прямо      |
|       0x4      | направление 0 градусов, зеркально  |
|       0x1      | направление 90 градусов, прямо     |
|       0x5      | направление 90 градусов, зеркально |
|       0x2      | направление 180 градусов, прямо    |
|       0x6      | направление 180 градусов, зеркально|
|       0x3      | направление 270 градусов, прямо    |
|       0x7      | направление 270 градусов, зеркально|

Как можно заметить, наличие зеркальности определяется установленным 2-м битом тетрады.


Выравнивание опеределяют следующие две тетрады поля "Ориентация и выравнивание текста"
(биты с 4-го по 11, вместе образуют байт). Тип выравнивания текста в нижележащей таблице кодируется
двумя словами через дефис, первое из которых указывает способ выключки текста по горизонтали, а второе
слово - по вертикали.

* #### Выравнивание (выключка) текста

|Значение кодирующего байта|      Выравнивание текста      |
|:------------------------:|:-----------------------------:|
|          0x21            |   выравнивание "лево-верх"    |
|          0x23            |   выравнивание "лево-центр"   |
|          0x22            |   выравнивание "лево-низ"     |
|          0x19            |   выравнивание "центр-верх"   |
|          0x1B            |   выравнивание "центр-центр"  |
|          0x1A            |   выравнивание "центр-низ"    |
|          0x29            |   выравнивание "право-верх"   |
|          0x2B            |   выравнивание "право-центр"  |
|          0x2A            |   выравнивание "право-низ"    |

Способ хранения самого содержимого текстовой строки в последнем поле описателя также требует специальных
пояснений. Наиболее целесообразно дать такое пояснение конструктивно, то есть описанием алгоритма его формирования
редакторами комплекса PCAD8. Такой своеобразный способ хранения текста связан опять-таки с применением порядка
байтов "big-endian".

Текст представляет собой ASCIIZ-строку, то есть должен оканчиваться нулевым байтом. Кроме того, длина полученной
строки (с учётом завершающего нуля) должна быть кратна 8 байтам (двум двойным словам). Если это не так, она
дополняется нулями до границы счетверённого слова (то есть 8 байт). Затем этот текст сохраняется в целевой области
памяти, после чего эта область разделяется на отдельные двойные слова, каждое из которых разворачивается в обратном
порядке байтов. И наконец, подвергнутая такому преобразованию область сохраняется в файл.
Например текст "ABCDEFGHIJKLMNOP." (длиной 17 байт вместе с завершающем нулём)будет храниться в файле как
"DCBAHGFELKJIPONM........"(. - нулевой байт, выровненная длина - 24 байта). Для корректного считывания текстового
значения его следует подвергнуть обратной процедуре.

#### Вспышка (засветка, апертура)

Длина описателя - 16 байт.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 4 байта    | uint32_t |Сигнатура примитива "вспышка(апертура)"|        =0x80000405         |
| 4                       | 2 байта    | uint16_t |          Ориентация вспышки           |  =0 - поворот 0 градусов   |
|                         |            |          |                                       |  =1 - поворот 90 градусов  |
|                         |            |          |                                       |  =2 - поворот 180 градусов |
|                         |            |          |                                       |  =3 - поворот 270 градусов |
| 6                       | 2 байта    | uint16_t |Номер апертуры во внешнем файле апертур|                            |
| 8                       | 4 байта    | int32_t  |    Координата x центра вспышки        |                            |
| 12                      | 4 байта    | int32_t  |    Координата y центра вспышки        |                            |

#### Многоугольник (полигон)

Длина описателя - переменная.

Это составной примитив, состоящий из одного описания собственно рисуемого полигона, а также произвольного
количества описаний двух других элементов - выемок внутри этого полигона, которые, в свою очередь, могут быть
многоугольными и круглыми.

Сначала располагается описание самого полигона, которое, в свою очередь, состоит из небольшого заголовка фиксированной
структуры и списка вершин полигона, количество записей в котором переменное и равно количеству вершин в полигоне.
Затем - список выемок из полигона, которые находятся внутри его тела.

|Смещение от начала записи| Размер     |     Тип    |            Назначение                 |          Значение           |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:---------------------------:|
| 0                       | 4 байта    |  uint32_t  |  Сигнатура примитива "многоугольник"  |        =0x80000413          |
| 4                       | 2 байта    |  uint16_t  |     Ширина (толщина) апертуры для     |                             |
|                         |            |            |       отрисовки сторон полигона       |                             |
| 6                       | 2 байта    |  uint16_t  |Тип заполнения внутреннего пространства|  =1 - сплошная заливка      |
|                         |            |            |           многоугольника              |  =2 - штриховка             |
| 8                       | 8 байт     |VertexStruct|    Описатель вершины многоугольника   |  первая вершина полигона    |
|........................ |............|............|.......................................|.............................|
| xxx                     | 8 байт     |VertexStruct|    Описатель вершины многоугольника   | очередная вершина полигона  |
|........................ |............|............|.......................................|.............................|
| xxx                     | 8 байт     |VertexStruct|    Описатель вершины многоугольника   | последняя вершина полигона  |
| xxx                     | xxx        | xxx        |        Элемент списка выемок          |  первая выемка из полигона  |
|........................ |............|............|.......................................|.............................|
| xxx                     | xxx        | xxx        |    Завершающий элемент списка выемок  |сигнатура конца списка выемок|

#### VertextStruct:

Структуру VertextStruct можно описать так

    struct VertextStruct
    {
      int32_t vertex_x; // Координата x вершины полигона
      int32_t vertex_y; // Координата y вершины полигона
    };

или так:

|Смещение от начала записи| Размер     |     Тип    |         Назначение               |
|:-----------------------:|:----------:|:----------:|:--------------------------------:|
| 0                       | 4 байта    |  int32_t   |  Координата x вершины полигона   |
| 4                       | 4 байта    |  int32_t   |  Координата y вершины полигона   |

Окончание перечня вершин фиксируется по наличию на месте очередной структуры VertexStruct одной
из трёх 8-байтовых сигнатур (0x800003EF00000000, 0x800003EE00000000 или 0x800003F000000000),
смысл и назначение которых описаны ниже.

Сразу вслед за списком вершин многоугольника в файле помещается описание выемок в полигоне. Такое
описание, в свою очередь, представляет отдельный собой список элементов, каждый из которых очерчивает
отдельную выемку. Элементы списка располагаются друг за другом вплотную, без разделителей.

Структура отдельного элемента такого списка может иметь три разные формы.

* #### Форма для круглой выборки:

|Смещение от начала записи| Размер     |     Тип    |            Назначение                 |               Значение             |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:----------------------------------:|
| 0                       | 8 байт     |  uint64_t  |  Сигнатура круглой выемки из полигона |=0x800003EF00000000 - круглая выемка|
| 8                       | 4 байта    |  int32_t   |    Координата x центра круглой выемки |                                    |
| 12                      | 4 байта    |  int32_t   |    Координата y центра круглой выемки |                                    |
| 16                      | 4 байта    |  int32_t   |         Радиус круглой выемки         |                                    |
| 20                      | 4 байта    |  int32_t   |          Нулевой заполнитель          | =0                                 |

* #### Форма для многоугольной выборки:

|Смещение от начала записи| Размер     |     Тип    |            Назначение                 |               Значение             |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:----------------------------------:|
| 0                       | 8 байт     |  uint64_t  |   Сигнатура многоугольной выемки из   |=0x800003EE00000000 - многоугольная |
|                         |            |            |              полигона                 |                  выемка            |
| 8                       | 8 байт     |VertexStruct|Описатель вершины многоугольной выемки |         первая вершина выемки      |
|........................ |............|............|.......................................|....................................|
| xxx                     | 8 байт     |VertexStruct|Описатель вершины многоугольной выемки |        очередная вершина выемки    |
|........................ |............|............|.......................................|....................................|

Окончание перечня вершин фиксируется по наличию на месте очередной структуры VertexStruct одной из трёх 
8-байтовых сигнатур (0x800003EF00000000, 0x800003EE00000000 или 0x800003F000000000), с которых начинается
следующий элемент списка.

* #### Форма для завершающего элемента списка.

Она заканчивает описание полигона и состоит только из сигнатуры.

|Смещение от начала записи| Размер     |     Тип    |              Назначение               |               Значение             |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:----------------------------------:|
| 0                       | 8 байт     |  uint64_t  |    Сигнатура конца списка выемок      |=0x800003F000000000 - конец списка  |
|                         |            |            |              из полигона              |выемок и описания полигона в целом  |


