
Описание (спецификация) формата файлов PLT4.
============================================

Введение и общие сведения.
--------------------------

Файлы PLT создаются графическими редакторами комплекса PCAD (PCCAPS и PCCARDS) в качестве упрощенного представления
создаваемого в них изображения, очищенного от любых побочных и сопутствующих сведений, которые в изобилии содержатся
в файлах основных рабочих форматов этих программ (*.SYM, *.SCH, *.PRT, *.PCB). Хранимое в файлах изображение является
векторным и состоит из набора некоторых базовых геометрических примитивов.

Для хранения любых значений в файлах этого формата используются байтовые целые беззнаковые и двухбайтовые
целые знаковые величины.

Все геометрические размеры (координаты и толщины) хранятся в виде особых единиц базы данных - DBU.
Связь условных единиц DBU с геометрическими единицами длины зависит от типа создавшего рисунок редактора.

Для редактора PC-CAPS при работе в метрической системе единица координат редактора (единица
при работе в редакторе) соответствует миллиметру, равному 10 DBU (1 DBU = 0.1 мм).
В английской системе единица координат - сотая доля дюйма = 0.01 дюйма = 10 милов = 0.254 мм
= 1 DBU (1 DBU = 0.01 дюйма = 0.254 мм).

Для редакторов PC-CARDS и PC-PLACE единицы DBU на порядок (в 10 раз) плотнее (меньше). Тут при
работе в метрической системе единицей координат редактора по-прежнему является миллиметр, но
он уже соответствует 100 DBU (1 DBU = 0.01 мм). В английской системе единицей координат редактора
будет уже тысячная доля дюйма (мил), и в базе данных она будет соответствовать 1 DBU.
Таким образом, для английской системы в PC-CARDS имеем: 1 DBU = 1 мил = 0.001 дюйма =
0.0254 мм.

Система координат в плоскости изображения декартова, с традиционным направлением координатных осей: ось абсцисс
горизонтальна, направлена слева направо, ось ординат вертикальна, направлена снизу вверх.

Детальное описание структуры и формата файла PLT4.
--------------------------------------------------

Общая структура файла PLT4, создаваемого редакторами комплекса PCAD4, выглядит так:

1. Заголовок фиксированного формата
2. Таблица включённых слоёв
3. Список графических примитивов

Далее каждый из них будет описан подробно.

#### Заголовок фиксированного формата.

Описанный (объемлющий) прямоугольник - прямоугольник, внутри которого помещается всё изображение файла.

|Смещение    | Размер     |    Тип   |          Назначение               |                 Значение                  |
|:----------:|:----------:|:--------:|:---------------------------------:|:-----------------------------------------:|
| 0          | 4 байта    | uint32_t |     Сигнатура формата файла       |               =0x4E800400                 |
| 4          | 2 байта    | int16_t  | Координата X левого нижнего угла  |                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 6          | 2 байта    | int16_t  | Координата y левого нижнего угла  |                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 8          | 2 байта    | int16_t  | Координата x правого верхнего угла|                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 10         | 2 байта    | int16_t  | Координата y правого верхнего угла|                                           |
|            |            |          |    описанного прямоугольника      |                                           |
| 12         | 2 байта    | uint16_t |      Тип координатной системы     | =0x2 для английской (дюймовой) системы    |
|            |            |          |                                   | =0x7 для метрической системы              |
| 14         | 2 байта    | uint16_t |   Тип редактора-создателя файла   | =0x1, если файл создан редактором PC-CARDS|
|            |            |          |                                   |                или PC-PLACE               |
|            |            |          |                                   | =0xA, если файл создан редактором PC-CAPS |
| 16         | 2 байта    | uint16_t | Количество записей в таблице слоёв| =NLAY                                     |
| 18         | 2 байта    | uint16_t |           Нулевое слово           | =0, сигнатура завершения заголовка        |

#### Таблица включённых (отображаемых) слоёв

Сразу вслед за заголовком фиксированного формата находится таблица включённых (отображаемых) слоёв. В этой таблице
содержится ровно столько записей, сколько указано в заголовке в поле "Количество записей в таблице слоёв". Длина одной
записи - 8 байт.

##### Структура таблицы слоёв.

|Смещение    | Размер     |     Тип       |            Назначение                |
|:----------:|:----------:|:-------------:|:------------------------------------:|
|  20        |  8 байт    | layer_struct  |  Описание первого включённого слоя   |
| .......... | .......... | ............. | .................................... |
| .......... | .......... | ............. | .................................... |
| 20+N*8     |  8 байт    | layer_struct  | Описание последнего включённого слоя |

#### Описание layer_struct каждого слоя выглядит так:

|Смещение от начала записи| Размер     |    Тип   |           Назначение             | 
|:-----------------------:|:----------:|:--------:|:--------------------------------:|
| 0                       | 6 байт     | char[6]  |            Имя слоя              |
| 6                       | 1 байт     | uint8_t  |Порядковый номер слоя в исходной  |
|                         |            |          |таблице слоёв редактора (команда  |
|                         |            |          |              VLYR)               |
| 7                       | 1 байт     | uint8_t  |Индекс палитры - цвет, назначенный|
|                         |            |          |слою (от 0 до 15)                 |

Если имя слоя короче 6 байт, то оно может дополняться до шести байт любыми кодами, но его действительная
часть в этом случае обязательно отделяется от заполнителя нулевым байтом.

Основная часть файла - перечисление графических элементов изображения.
----------------------------------------------------------------------

После завершения таблицы слоёв следует массив описаний графических примитивов, и образующих, собственно
изображение. Всего определено 9 геометрических примитивов:

1. Назначение цвета следующим примитивам
2. Отрезок (линия)
3. Прямоугольник
4. Заполненный (закрашенный) прямоугольник
5. Окружность
6. Дуга окружности
7. Строка текста
8. Вспышка (засветка, апертура)
9. Многоугольник (полигон)

Описатели примитивов следуют вплотную друг за другом, без каких-либо разделителей. Они могут иметь как
фиксированный формат, так и переменную длину. Подробное разъяснение их устройства следует далее.

### Описание геометрических примитивов изображения.

#### Назначение цвета следующим примитивам

Длина описателя - 4 байта.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t | Сигнатура примитива "назначение цвета"|          =0x80A9           |
| 2                       | 1 байт     | uint8_t  | Нулевой байт                          |  =0                        |
| 3                       | 1 байт     | uint8_t  | Индекс палитры - цвет, которым будут  |     Значение от 0 до 15    |
|                         |            |          | рисоваться следующие примитивы (кроме |                            |
|                         |            |          | примитива "закрашенный прямоугольник")|                            |

#### Отрезок (линия)

Длина описателя - 12 байтов.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t | Сигнатура примитива "линия (отрезок)" |          =0x80A8           |
| 2                       | 1 байт     | uint8_t  |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 3                       | 1 байт     | uint8_t  |        Ширина (толщина) линии         |                            |
| 4                       | 2 байта    | int16_t  | Координата X начальной точки отрезка  |                            |
| 6                       | 2 байта    | int16_t  | Координата y начальной точки отрезка  |                            |
| 8                       | 2 байта    | int16_t  | Координата x конечной точки отрезка   |                            |
| 10                      | 2 байта    | int16_t  | Координата y конечной точки отрезка   |                            |

#### Прямоугольник

Длина описателя - 12 байтов.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t | Сигнатура примитива "прямоугольник"   |          =0x80A7           |
| 2                       | 1 байт     | uint8_t  |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 3                       | 1 байт     | uint8_t  |        Ширина (толщина) линии         |                            |
| 4                       | 2 байта    | int16_t  |    Координата X нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 6                       | 2 байта    | int16_t  |    Координата y нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 8                       | 2 байта    | int16_t  |    Координата x верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |
| 10                      | 2 байта    | int16_t  |    Координата y верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |

#### Заполненный (закрашенный) прямоугольник

Длина описателя - 12 байтов.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t |   Сигнатура примитива "заполненный    |          =0x80A6           |
|                         |            |          |      (закрашенный) прямоугольник"     |                            |
| 2                       | 1 байт     | uint8_t  | Цвет рисуемой фигуры - индекс палитры |    Значение от 0 до 15     |
| 3                       | 1 байт     | uint8_t  |            Нулевой байт               |    =0                      |           
| 4                       | 2 байта    | int16_t  |    Координата X нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 6                       | 2 байта    | int16_t  |    Координата y нижней левой точки    |                            |
|                         |            |          |            прямоугольника             |                            |
| 8                       | 2 байта    | int16_t  |    Координата x верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |
| 10                      | 2 байта    | int16_t  |    Координата y верхней правой точки  |                            |
|                         |            |          |            прямоугольника             |                            |

#### Окружность

Длина описателя - 16 байт.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t |    Сигнатура примитива "окружность"   |          =0x80A5           |
| 2                       | 1 байт     | uint8_t  |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 3                       | 1 байт     | uint8_t  |        Ширина (толщина) линии         |                            |
| 4                       | 2 байта    | int16_t  |    Координата X центра окружности     |                            |
| 6                       | 2 байта    | int16_t  |    Координата y центра окружности     |                            |
| 8                       | 2 байта    | uint16_t |           Радиус окружности           |                            |
| 10                      | 6 байтов   | int8_t[6]|          Нулевой заполнитель          | =0                         |

#### Дуга окружности

Длина описателя - 16 байт.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t | Сигнатура примитива "дуга окружности" |          =0x807A           |
| 2                       | 1 байт     | uint8_t  |             Тип линии                 | =0 - сплошная линия (SOLID)|           
|                         |            |          |                                       | =1 - штриховая (DOTTED)    |
|                         |            |          |                                       | =2 - пунктирная (DASHED)   |
| 3                       | 1 байт     | uint8_t  |        Ширина (толщина) линии         |                            |
| 4                       | 2 байта    | int16_t  |    Координата x центра окружности     |                            |
| 6                       | 2 байта    | int16_t  |    Координата y центра окружности     |                            |
| 8                       | 2 байта    | int16_t  |    Координата x начальной точки дуги  |                            |
| 10                      | 2 байта    | int16_t  |    Координата y начальной точки дуги  |                            |
| 12                      | 2 байта    | int16_t  |    Координата x конечной точки дуги   |                            |
| 14                      | 2 байта    | int16_t  |    Координата y конечной точки дуги   |                            |

Обе конечных точки должны принадлежать дуге, но если вторая точка на ней не лежит, то первая (начальная) точка используется
для расчёта радиуса дуги (расстояние от центра до этой точки) и стартового угла, а вторая (конечная) - только для расчёта
её финального угла.

#### Строка текста

Длина описателя - переменная.

|Смещение от начала записи| Размер   |    Тип    |            Назначение                 |           Значение         |
|:-----------------------:|:--------:|:---------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта  | uint16_t  |  Сигнатура примитива "строка текста"  |           =0x80A2          |
| 2                       | 2 байта  | uint16_t  |         Нулевой заполнитель           |  =0                        |
| 4                       | 2 байта  | int16_t   |   Координата x точки привязки текста  |                            |
| 6                       | 2 байта  | int16_t   |   Координата y точки привязки текста  |                            |
| 8                       | 1 байт   | uint8_t   |          Ориентация текста            | Разъяснение ниже           |
| 9                       | 2 байта  | uint16_t  |             Высота текста             | Разъяснение ниже           |
| 11                      | 1 байт   | uint8_t   |     Выравнивание (выключка) текста    | Разъяснение ниже           |
| 12                      | N байтов | char[N]|  |      Содержимое текстовой строки      | Смотри комментарий ниже    |

* #### Ориентация (направление) текста

|Значение тетрады|Ориентация текста                   |
|:--------------:|:----------------------------------:|
|       0x0      | направление 0 градусов, прямо      |
|       0x4      | направление 0 градусов, зеркально  |
|       0x1      | направление 90 градусов, прямо     |
|       0x5      | направление 90 градусов, зеркально |
|       0x2      | направление 180 градусов, прямо    |
|       0x6      | направление 180 градусов, зеркально|
|       0x3      | направление 270 градусов, прямо    |
|       0x7      | направление 270 градусов, зеркально|

Поворот на указанное количество градусов делается против часовой стрелки.
Как можно заметить, наличие зеркальности определяется установленным 2-м битом поля.

Тип выравнивания текста в нижележащей таблице кодируется двумя словами через дефис,
первое из которых указывает способ выключки текста по горизонтали, а второе слово - по вертикали.

* #### Выравнивание (выключка) текста

|Значение поля выравнивания|      Выравнивание текста      |
|:------------------------:|:-----------------------------:|
|          0x21            |   выравнивание "лево-верх"    |
|          0x23            |   выравнивание "лево-центр"   |
|          0x22            |   выравнивание "лево-низ"     |
|          0x19            |   выравнивание "центр-верх"   |
|          0x1B            |   выравнивание "центр-центр"  |
|          0x1A            |   выравнивание "центр-низ"    |
|          0x29            |   выравнивание "право-верх"   |
|          0x2B            |   выравнивание "право-центр"  |
|          0x2A            |   выравнивание "право-низ"    |

Текст представляет собой ASCIIZ-строку, то есть должен оканчиваться нулевым байтом. Кроме того, длина полученной
строки (с учётом завершающего нуля) должна быть кратна 4 байтам (двойному слову). Если это не так, она
дополняется нулями до границы двойного слова (то есть 4 байт).

Поле "Высота текста" = WF определяет размер шрифта, но байты слова рассматриваются как 7-битовые и истинная высота
текста рассчитывается так: 

W = HIBYTE(WF) * 128 + LOBYTE(WF) = <старший байт>(WF) * 128 + <младший байт>(WF)

#### Вспышка (засветка, апертура)

Длина описателя - 8 байт.

|Смещение от начала записи| Размер     |    Тип   |            Назначение                 |          Значение          |
|:-----------------------:|:----------:|:--------:|:-------------------------------------:|:--------------------------:|
| 0                       | 2 байта    | uint16_t |Сигнатура примитива "вспышка(апертура)"|          =0x8095           |
| 2                       | 1 байт     | uint8_t  |Номер апертуры во внешнем файле апертур|                            |
| 3                       | 1 байт     | uint8_t  |          Ориентация вспышки           |  =0 - поворот 0 градусов   |
|                         |            |          |                                       |  =1 - поворот 90 градусов  |
|                         |            |          |                                       |  =2 - поворот 180 градусов |
|                         |            |          |                                       |  =3 - поворот 270 градусов |
| 4                       | 2 байта    | int16_t  |    Координата x центра вспышки        |                            |
| 6                       | 2 байта    | int16_t  |    Координата y центра вспышки        |                            |

#### Многоугольник (полигон)

Длина описателя - переменная.

Это составной примитив, состоящий из одного описания собственно рисуемого полигона, а также произвольного
количества описаний двух других элементов - выемок внутри этого полигона, которые, в свою очередь, могут быть
многоугольными и круглыми.

Сначала располагается описание самого полигона, которое, в свою очередь, состоит из небольшого заголовка фиксированной
структуры и списка вершин полигона, количество записей в котором переменное и равно количеству вершин в полигоне.
Затем - список выемок из полигона, которые находятся внутри его тела.

|Смещение от начала записи| Размер     |     Тип    |            Назначение                 |          Значение           |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:---------------------------:|
| 0                       | 2 байта    |  uint16_t  |  Сигнатура примитива "многоугольник"  |          =0x80A3            |
| 2                       | 1 байт     |  uint8_t   |Тип заполнения внутреннего пространства|  =1 - сплошная заливка      |
|                         |            |            |           многоугольника              |  =2 - штриховка             |
| 3                       | 1 байт     |  uint8_t   |     Ширина (толщина) апертуры для     |                             |
|                         |            |            |       отрисовки сторон полигона       |                             |
| 4                       | 4 байта    |VertexStruct|    Описатель вершины многоугольника   |  первая вершина полигона    |
|........................ |............|............|.......................................|.............................|
| xxx                     | 4 байта    |VertexStruct|    Описатель вершины многоугольника   | очередная вершина полигона  |
|........................ |............|............|.......................................|.............................|
| xxx                     | 4 байта    |VertexStruct|    Описатель вершины многоугольника   | последняя вершина полигона  |
| xxx                     | xxx        | xxx        |        Элемент списка выемок          |  первая выемка из полигона  |
|........................ |............|............|.......................................|.............................|
| xxx                     | xxx        | xxx        |    Завершающий элемент списка выемок  |сигнатура конца списка выемок|

#### VertextStruct:

Структуру VertextStruct можно описать так

    struct VertextStruct
    {
      int16_t vertex_x; // Координата x вершины полигона
      int16_t vertex_y; // Координата y вершины полигона
    };

или так:

|Смещение от начала записи| Размер     |     Тип    |         Назначение               |
|:-----------------------:|:----------:|:----------:|:--------------------------------:|
| 0                       | 2 байта    |  int16_t   |  Координата x вершины полигона   |
| 2                       | 2 байта    |  int16_t   |  Координата y вершины полигона   |

Окончание перечня вершин фиксируется по наличию на месте очередной структуры VertexStruct одной
из трёх 4-байтовых сигнатур (0x0000807F, 0x0000807E или 0x00008080), смысл и назначение которых
описаны ниже.

Сразу вслед за списком вершин многоугольника в файле помещается описание выемок в полигоне. Такое
описание, в свою очередь, представляет отдельный собой список элементов, каждый из которых очерчивает
отдельную выемку. Элементы списка располагаются друг за другом вплотную, без разделителей.

Структура отдельного элемента такого списка может иметь три разные формы.

* #### Форма для круглой выборки:

|Смещение от начала записи| Размер     |     Тип    |            Назначение                 |               Значение             |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:----------------------------------:|
| 0                       | 4 байта    |  uint32_t  |  Сигнатура круглой выемки из полигона |  =0x0000807F - круглая выемка      |
| 4                       | 2 байта    |  int16_t   |    Координата x центра круглой выемки |                                    |
| 6                       | 2 байта    |  int16_t   |    Координата y центра круглой выемки |                                    |
| 8                       | 2 байта    |  uint16_t  |         Радиус круглой выемки         |                                    |
| 10                      | 2 байта    |  uint16_t  |          Нулевой заполнитель          | =0                                 |

* #### Форма для многоугольной выборки:

|Смещение от начала записи| Размер     |     Тип    |            Назначение                 |               Значение             |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:----------------------------------:|
| 0                       | 4 байта    |  uint32_t  |   Сигнатура многоугольной выемки из   | =0x0000807E - многоугольная выемка |
|                         |            |            |              полигона                 |                                    |
| 4                       | 4 байта    |VertexStruct|Описатель вершины многоугольной выемки |         первая вершина выемки      |
|........................ |............|............|.......................................|....................................|
| xxx                     | 4 байта    |VertexStruct|Описатель вершины многоугольной выемки |        очередная вершина выемки    |
|........................ |............|............|.......................................|....................................|

Окончание перечня вершин фиксируется по наличию на месте очередной структуры VertexStruct одной из трёх 
4-байтовых сигнатур (0x0000807F, 0x0000807E или 0x00008080), с которых начинается следующий элемент списка.

* #### Форма для завершающего элемента списка.

Она заканчивает описание полигона и состоит только из сигнатуры.

|Смещение от начала записи| Размер     |     Тип    |              Назначение               |               Значение             |
|:-----------------------:|:----------:|:----------:|:-------------------------------------:|:----------------------------------:|
| 0                       | 4 байта    |  uint32_t  |    Сигнатура конца списка выемок      |=0x00008080 - конец списка выемок и |
|                         |            |            |              из полигона              |описания полигона в целом           |
